"use strict";var geolocFunction=function(a,b){var c=b.defer();return a.getUserPos().then(function(a){c.resolve(a)},function(a){c.resolve(a)}),c.promise};angular.module("trenesMobile",["trenesMobile.controllers","trenesMobile.services","trenesMobile.directives","ngTouch","ngRoute","ngAnimate"]).config(["$routeProvider",function(a){a.when("/",{templateUrl:"partials/home.html",controller:"IndexCtrl",resolve:{HomeData:["rutas","paradas","horarios","$q",function(a,b,c,d){var e=d.defer();return b.getParadas().then(function(b){a.getRutasConHorariosActuales().then(function(a){c.getHorarios().then(function(c){e.resolve({rutasData:a,paradasData:b,horariosData:c})})})}),e.promise}],User:["user","$q",geolocFunction]}}).when("/near/:id",{templateUrl:"views/near.html",controller:"NearCtrl",resolve:{Paradas:["paradas","$q",function(a,b){var c=b.defer();return a.getParadas().then(function(a){c.resolve(a)}),c.promise}],User:["user","$q",geolocFunction]}}).otherwise({redirectTo:"/"})}]).run(["$rootScope",function(a){a.displayViewChangeOverlay=!1,a.$on("$routeChangeStart",function(){a.displayViewChangeOverlay=!0}),a.$on("$routeChangeSuccess",function(){a.displayViewChangeOverlay=!1})}]),angular.module("trenesMobile.controllers",[]).controller("MainCtrl",["$scope","$rootScope","$window","$location",function(a,b,c,d){a.slideClass="gr",b.back=function(){a.slideClass="slide-right",c.history.back()},b.go=function(b){a.slideClass="slide-left",d.url(b)},b.goBack=function(b){a.slideClass="slide-right",d.url(b)}}]),angular.module("trenesMobile.controllers").controller("IndexCtrl",["$scope","HomeData","User","$interval",function(a,b,c,d){function e(a,b){var c=_.map(a,function(a){var c=6371,d=f(b.latitude-a.lat),e=f(b.longitude-a.lng),g=Math.sin(d/2)*Math.sin(d/2)+Math.cos(f(a.lat))*Math.cos(f(b.latitude))*Math.sin(e/2)*Math.sin(e/2),h=2*Math.atan2(Math.sqrt(g),Math.sqrt(1-g)),i=c*h,j={id:a.id,distance:i};return j});return c}function f(a){return a*Math.PI/180}a.paradas=b.paradasData,a.rutas=b.rutasData,a.horario=b.horariosData,a.showDrop=!1,a.slide="",a.showClosestSprintStore=!0,a.hurryUp={},a.closeSprintStoreLocation=function(){a.showClosestSprintStore=!1};var g=e(a.paradas,c.coords),h=_.min(_.pluck(g,"distance")),i=_.where(g,{distance:h}),j=_.where(a.paradas,{id:i[0].id});a.near=j[0];var k=_.where(a.horario,{parada:i[0].id});d(function(){var b=_.map(k,function(b){var c=/\d+/g,d=b.tiempo.match(c)[0],e=b.tiempo.match(c)[1],f=moment(),g=moment(""+d+":"+e,"HH:mm"),h=Math.abs(moment.duration(f-g).asMinutes()),i=_.where(a.rutas,{id:b.ruta}),j={horaID:b.id,diferencia:h,rutaID:b.ruta,rutaNombre:i[0].nombre,tiempo:b.tiempo};return j}),c=_.min(_.pluck(b,"diferencia"));a.lowHourObj=_.where(b,{diferencia:c}),a.hurryUp=moment.duration(c,"minutes")},1e3)}]),angular.module("trenesMobile.controllers").controller("MenuCtrl",["$scope",function(a){a.navOpen=!1,a.menuClick=function(){a.navOpen=!a.navOpen}}]),angular.module("trenesMobile.services",[]).factory("paradas",["storageWrapper","$q",function(a,b){return{getParadas:function(){return a.getData("paradas","http://horarios-tren-data.nodejitsu.com/parada")},getParada:function(a){var c=b.defer();return this.getParadas().then(function(b){var d=_.find(b,function(b){return b.id===a});c.resolve(d)}),c.promise},filtrar:function(a){var c=b.defer();return this.getParadas().then(function(b){var d=_.filter(b,function(b){return _.contains(a,b.id)});c.resolve(d)}),c.promise}}}]),angular.module("trenesMobile.services").factory("rutas",["storageWrapper","horarios","$q",function(a,b,c){return{getRutas:function(){return a.getData("rutas","http://horarios-tren-data.nodejitsu.com/ruta")},getRutasConHorariosActuales:function(){var a=c.defer();return this.getRutas().then(function(c){b.getHorariosActuales().then(function(b){_.each(c,function(a){a.horariosActuales=b[a.id]||[]}),a.resolve(c)})}),a.promise}}}]),angular.module("trenesMobile.services").factory("horarios",["storageWrapper","paradas","$q",function(a,b,c){var d={1:5,2:5,3:5,4:5,5:5,6:6,7:7,8:8,9:9,10:15,11:15,12:15,13:15,14:15,15:15,16:16,17:17,18:18,19:19,20:20,21:5,22:5,23:5,24:5},e={0:[0,14],15:[15,29],30:[30,44],45:[45,59]};return{getHorarios:function(){return a.getData("horarios","http://horarios-tren-data.nodejitsu.com/horario")},getHorariosActuales:function(){var a=c.defer(),f=moment().hours(),g=moment().minutes(),h=d[f],i=e[0];return f===h&&_.each(e,function(a){g>=a[0]&&g<=a[1]&&(i=a)}),15===h&&15!==f&&(i=e[30]),20===h&&g>30&&(i=e[15]),this.getHorarios().then(function(c){var d=_.filter(c,function(a){var b=a.tiempo.split(":"),c=_.parseInt(b[1]);return _.parseInt(b[0])===h&&c>i[0]&&c<i[1]});b.filtrar(_.pluck(d,"parada")).then(function(b){_.each(d,function(a){a.parada=_.find(b,function(b){return b.id===a.parada})}),a.resolve(_.groupBy(d,function(a){return a.ruta}))})}),a.promise}}}]),angular.module("trenesMobile.services").factory("user",["$q","$window","$rootScope",function(a,b,c){var d={timestamp:1396975380431,coords:{speed:null,heading:null,altitudeAccuracy:null,accuracy:36,altitude:null,longitude:-84.04992109999999,latitude:9.932789}};return{getUserPos:function(){var e=a.defer();return b.navigator&&b.navigator.geolocation?b.navigator.geolocation.getCurrentPosition(function(a){c.$apply(function(){e.resolve(a)})},function(a){console.log("ERROR: when geoloc..., sending default coords"+JSON.stringify(a)),c.$apply(function(){e.resolve(d)})}):e.resolve(d),e.promise}}}]),angular.module("trenesMobile.services").factory("storageWrapper",["$q","$http","$cacheFactory",function(a,b,c){return{getData:function(d,e){var f,g=a.defer(),h="tren-factory";return f=_.isUndefined(c.get(h))?c(h):c.get(h),_.isUndefined(f.get(d))?b.get(e).success(function(a){f.put(d,a),g.resolve(a)}).error(function(a){g.reject(a)}):g.resolve(f.get(d)),g.promise}}}]),angular.module("trenesMobile.directives",[]).directive("menuaction",["$window","$document",function(a,b){return{templateUrl:"partials/menu.html",restrict:"E",link:function(c,d){function e(){l.find(".main-cont").transition({x:0},500),k.transition({x:0},500,function(){j.removeClass("menu-options")}),m=!1}function f(){l.find(".main-cont").transition({x:h},500),k.transition({x:h},500),j.addClass("menu-options"),m=!0}var g=a.innerHeight,h=.7*a.innerWidth,i=d.find("#menu-icon"),j=(d.find(".menu-options"),d.find(".menu-here")),k=d.find(".pure-menu"),l=b.find("body"),m=!1;j.height(g),j.width(h),i.bind("click",function(){m?e():(f(),l.find(".main-cont").bind("click",function(){e()}))})}}}]),angular.module("trenesMobile.controllers").controller("NearCtrl",["$scope","$routeParams","Paradas","User",function(a,b,c,d){var e=b.id,f=_.where(c,{id:e}),g=d.coords;a.map={center:{latitude:f[0].lat,longitude:f[0].lng,name:"paradaStatic"},markers:[{latitude:f[0].lat,longitude:f[0].lng,name:"paradaStatic"},{latitude:g.latitude,longitude:g.longitude,name:"userWatcher"}]}}]),angular.module("trenesMobile.directives").directive("fulldiv",["$window",function(a){return{restrict:"A",link:function(b,c){var d=a.innerHeight;c.height(d)}}}]),angular.module("trenesMobile.directives").directive("routeMap",["$interval","$timeout",function(a,b){return{scope:{objmap:"="},restrict:"A",link:function(a,c,d){function e(a){_.each(a,function(a){f.addMarker({lat:a.latitude,lng:a.longitude,title:a.name,click:function(){alert("You clicked in this marker")}})})}var f=new GMaps({div:"#"+d.id,lat:a.objmap.markers[1].latitude,lng:a.objmap.markers[1].longitude}),g=new google.maps.Marker({position:new google.maps.LatLng(a.objmap.markers[1].latitude,a.objmap.markers[1].longitude),title:"Your Location",draggable:!0,map:f.map});f.map.setCenter(g.getPosition());var h="custom_style",i=[{stylers:[{hue:"#007993"},{visibility:"on"},{gamma:1},{weight:2},{invert_lightness:!0}]},{featureType:"water",stylers:[{color:"#007993"}]},{featureType:"transit.line",stylers:[{color:"#BF4B4B"},{weight:5}]}],j={mapTypeControlOptions:{mapTypeIds:[google.maps.MapTypeId.ROADMAP,h]},mapTypeId:h},k={name:"Estilo Tren"},l=new google.maps.StyledMapType(i,k);f.map.setOptions(j),f.map.mapTypes.set(h,l),e(a.objmap.markers),f.travelRoute({origin:[a.objmap.markers[1].latitude,a.objmap.markers[1].longitude],destination:[a.objmap.center.latitude,a.objmap.center.longitude],travelMode:"driving",step:function(a){$("#instructions").append("<li>"+a.instructions+"</li>"),$("#instructions li:eq("+a.step_number+")").delay(550*a.step_number).fadeIn(200,function(){f.drawPolyline({path:a.path,strokeColor:"#BF4B4B",strokeOpacity:1,strokeWeight:5})})}});{var m=_.where(f.markers,{title:"userWatcher"});navigator.geolocation.watchPosition(function(a){var b=new google.maps.LatLng(a.coords.latitude,a.coords.longitude);m[0].setPosition(b)})}b(function(){google.maps.event.trigger(f.map,"resize");var b=new google.maps.LatLngBounds;_.each(a.objmap.markers,function(a){b.extend(new google.maps.LatLng(a.latitude,a.longitude))}),f.map.fitBounds(b),console.log(f)},100)}}}]);